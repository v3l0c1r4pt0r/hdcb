#!/bin/sh
# function library for hdcb main script

prefix=@prefix@
datarootdir=@datarootdir@
datadir=@datadir@/@PACKAGE@
source ${datadir}/num-func.sh
source ${datadir}/file-func.sh

# initialize environment
function init {
    cursor=0
    clriterator=0
    clrstream=""
}

function squeeze {
    hd=$(hexdump -C $binfile)
}

# pick next default color pair
function pick {
    pickedcolor="${clrlist[$clriterator]}";
    # FIXME: removing color from array would be safer
    if [ "${clrlist[$clriterator]}t" == "t" ]; then
        echo "Warning! Exhausted all possible automatic color pairs";
        pickedcolor="9:0";
    fi;
    let clriterator++;
}

function color {
    if [ $# -lt 1 ]; then
        echo "Error! Invalid arguments for color()";
        exit 1;
    fi;

    length=$1
    offset=$cursor
    if [ $# -ge 2 ]; then
        color=$2;
    else
        pick;
        color=$pickedcolor;
    fi;

    if [ $# -ge 3 ]; then
        offset=$3
    fi;

    clrstream="$clrstream $offset $length ${color//:/ }";
    cursor=$((offset + length));
}

function print {
    echo "$hd" | ${datadir}/colour $clrstream;
}

# define new variable
# usage: define VARNAME length [bg-color fg-color]
function define {
    if [ $# -lt 2 ]; then
        echo "Error! Invalid arguments for define()";
        exit 1;
    fi;

    # args
    varname=$1
    len=$2
    if [ $# -ge 4 ];then
        bg=$3
        fg=$4
    else
        pick;
        bg=$(echo $pickedcolor | sed 's/^\(.*\):.*$/\1/')
        fg=$(echo $pickedcolor | sed 's/^.*:\(.*\)$/\1/')
    fi;

    vars[$varname,1]=$len
    vars[$varname,2]=$bg
    vars[$varname,3]=$fg
}

# use defined variable
# usage: use VARNAME [dup] [shellvar]
# NOTE: if shellvar ends with l, the value will be read as little-endian
function use {
    if [ $# -lt 1 ]; then
        echo "Error! Invalid arguments for use()" >&2;
        return 1;
    fi;
    len=${vars[$1,1]};
    shellvar=""
    if [ $# -ge 2 ] && [ "$2" -eq "$2" ] 2>/dev/null; then
        # duplicate variable DUP times
        let len*=$2;
    elif [ $# -ge 2 ]; then
        shellvar=$2
    fi;
    if [ $# -ge 3 ]; then
        shellvar=$3;
    fi;
    if [ ! -z "$shellvar" ]; then
        let typeindex=${#shellvar}-2;
        endianness=${shellvar:$typeindex:2};
        case "$endianness" in
            "_l" )
                value_le $shellvar $cursor $len || return 1;
                ;;
            "_b" )
                value_be $shellvar $cursor $len || return 1;
                ;;
            * )
                echo "Suffix $endianness not supported"
                eval $shellvar=0;
                return 1;
                ;;
        esac
    fi;
    color $len "${vars[$1,2]}:${vars[$1,3]}"
    return 0;
}

function legend {
    varnames=""
    esc="\e[0m"
    for index in ${!vars[*]}
    do
        re='^(.*),.*$'
        while [[ $index =~ $re ]]; do
            index=${BASH_REMATCH[1]}
        done
        varnames="$varnames$index\n"
    done
    echo
    for varname in $(echo -e "$varnames" | sort | uniq); do
        bg=${vars[$varname,2]}
        fg=${vars[$varname,3]}
        bgcmd="\e[38;5;${bg}m"
        fgcmd="\e[48;5;${fg}m"
        ttycursor;
        if (( $COLUMN + ${#varname} + 2 > 80 )); then
            echo
        fi;
        echo -ne "[$bgcmd$fgcmd$varname$esc] ";
    done;
    echo
}
